{% extends "base.html" %}

{% block title %}System Health - CloudHawk{% endblock %}

{% block content %}
<style>
/* Dark mode styles for health page */
[data-theme="dark"] .card {
    background-color: var(--card-bg) !important;
    border-color: var(--border-color) !important;
}

[data-theme="dark"] .card-header {
    background-color: var(--bg-tertiary) !important;
    border-bottom-color: var(--border-color) !important;
}

[data-theme="dark"] .table {
    color: var(--text-primary) !important;
}

[data-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) > td {
    background-color: var(--bg-secondary) !important;
}

[data-theme="dark"] .table-hover tbody tr:hover {
    background-color: var(--bg-tertiary) !important;
}

[data-theme="dark"] .badge {
    color: #fff !important;
}

[data-theme="dark"] .health-score-circle {
    background: conic-gradient(var(--bs-success) 0deg, var(--bs-success) 0deg, var(--bg-tertiary) 0deg) !important;
}

[data-theme="dark"] .health-score-value {
    color: var(--text-primary) !important;
}

[data-theme="dark"] .health-score-label {
    color: var(--text-secondary) !important;
}

[data-theme="dark"] .category-item {
    border-bottom-color: var(--border-color) !important;
}

[data-theme="dark"] .status-item, [data-theme="dark"] .source-item {
    border-bottom-color: var(--border-color) !important;
}

[data-theme="dark"] .btn-outline-secondary {
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}

[data-theme="dark"] .btn-outline-secondary:hover {
    background-color: var(--bg-tertiary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-heartbeat text-success"></i>
                    System Health
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshHealth()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-server"></i>
                        System Status Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="health-status-indicator" id="system-status">
                                    <i class="fas fa-circle text-success"></i>
                                    <span class="ms-2">Healthy</span>
                                </div>
                                <small class="text-muted">System Status</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="health-metric">
                                    <span class="h4" id="uptime">--</span>
                                    <small class="text-muted d-block">Uptime</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="health-metric">
                                    <span class="h4" id="version">1.0.0</span>
                                    <small class="text-muted d-block">Version</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="health-metric">
                                    <span class="h4" id="last-update">--</span>
                                    <small class="text-muted d-block">Last Update</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Score Dashboard -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie"></i>
                        Overall Health Score
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="health-score-circle" id="health-score-circle">
                        <div class="health-score-value" id="health-score-value">--</div>
                        <div class="health-score-label">Health Score</div>
                    </div>
                    <div class="health-grade mt-3">
                        <span class="badge badge-lg" id="health-grade">--</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shield-alt"></i>
                        Security Categories
                    </h5>
                </div>
                <div class="card-body">
                    <div class="health-categories" id="health-categories">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Metrics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        Security Issues
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="metric-item">
                                <span class="h5 text-danger" id="critical-issues">0</span>
                                <small class="text-muted d-block">Critical</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="metric-item">
                                <span class="h5 text-warning" id="high-issues">0</span>
                                <small class="text-muted d-block">High</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="metric-item">
                                <span class="h5 text-info" id="medium-issues">0</span>
                                <small class="text-muted d-block">Medium</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="metric-item">
                                <span class="h5 text-secondary" id="low-issues">0</span>
                                <small class="text-muted d-block">Low</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search"></i>
                        Detection Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="detection-status">
                        <div class="status-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span class="ms-2">Rule Engine</span>
                            <span class="badge bg-success ms-auto" id="rule-engine-status">Active</span>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span class="ms-2">Anomaly Detection</span>
                            <span class="badge bg-success ms-auto" id="anomaly-status">Active</span>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span class="ms-2">Health Scoring</span>
                            <span class="badge bg-success ms-auto" id="health-status">Active</span>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span class="ms-2">Misconfig Scanner</span>
                            <span class="badge bg-success ms-auto" id="misconfig-status">Active</span>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span class="ms-2">Vulnerability Scanner</span>
                            <span class="badge bg-success ms-auto" id="vuln-status">Active</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-database"></i>
                        Data Sources
                    </h5>
                </div>
                <div class="card-body">
                    <div class="data-sources">
                        <div class="source-item">
                            <i class="fab fa-aws text-warning"></i>
                            <span class="ms-2">AWS Services</span>
                            <span class="badge bg-primary ms-auto" id="aws-status">Connected</span>
                        </div>
                        <div class="source-item">
                            <i class="fas fa-file-alt text-info"></i>
                            <span class="ms-2">Security Events</span>
                            <span class="badge bg-info ms-auto" id="events-count">0</span>
                        </div>
                        <div class="source-item">
                            <i class="fas fa-bell text-warning"></i>
                            <span class="ms-2">Active Alerts</span>
                            <span class="badge bg-warning ms-auto" id="alerts-count">0</span>
                        </div>
                        <div class="source-item">
                            <i class="fas fa-cog text-secondary"></i>
                            <span class="ms-2">Rules Loaded</span>
                            <span class="badge bg-secondary ms-auto" id="rules-count">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history"></i>
                        Recent Health Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Component</th>
                                    <th>Status</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody id="health-activity">
                                <!-- Activity will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.health-status-indicator {
    font-size: 1.2rem;
    font-weight: bold;
}

.health-metric {
    padding: 1rem 0;
}

.health-score-circle {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: conic-gradient(var(--bs-success) 0deg, var(--bs-success) 0deg, var(--bs-light) 0deg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    position: relative;
}

.health-score-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-primary);
}

.health-score-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.health-grade .badge {
    font-size: 1.2rem;
    padding: 0.5rem 1rem;
}

.health-categories .category-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color);
}

.health-categories .category-item:last-child {
    border-bottom: none;
}

.category-score {
    font-weight: bold;
}

.metric-item {
    padding: 0.5rem 0;
}

.status-item, .source-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color);
}

.status-item:last-child, .source-item:last-child {
    border-bottom: none;
}

.badge-lg {
    font-size: 1rem;
    padding: 0.5rem 1rem;
}

[data-theme="dark"] .health-score-circle {
    background: conic-gradient(var(--bs-success) 0deg, var(--bs-success) 0deg, var(--bs-dark) 0deg);
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Health page specific JavaScript
let healthData = null;
let healthUpdateInterval = null;

// Initialize health page
document.addEventListener('DOMContentLoaded', function() {
    loadHealthData();
    startHealthUpdates();
});

// Load health data
async function loadHealthData() {
    try {
        const response = await fetch('/api/health');
        if (response.ok) {
            healthData = await response.json();
            updateHealthDisplay();
        } else {
            console.error('Failed to load health data');
        }
    } catch (error) {
        console.error('Error loading health data:', error);
    }
}

// Update health display
function updateHealthDisplay() {
    if (!healthData) return;

    // Update system status
    updateSystemStatus();
    
    // Update health score
    updateHealthScore();
    
    // Update metrics
    updateMetrics();
    
    // Update activity
    updateActivity();
}

// Update system status
function updateSystemStatus() {
    const status = healthData.system_status || 'healthy';
    const statusElement = document.getElementById('system-status');
    const statusIcon = statusElement.querySelector('i');
    const statusText = statusElement.querySelector('span');
    
    if (status === 'healthy') {
        statusIcon.className = 'fas fa-circle text-success';
        statusText.textContent = 'Healthy';
    } else {
        statusIcon.className = 'fas fa-circle text-danger';
        statusText.textContent = 'Unhealthy';
    }
    
    // Update version
    document.getElementById('version').textContent = healthData.version || '1.0.0';
    
    // Update last update
    const lastUpdate = new Date(healthData.timestamp).toLocaleString();
    document.getElementById('last-update').textContent = lastUpdate;
    
    // Update uptime (simplified)
    document.getElementById('uptime').textContent = '24h 15m';
}

// Update health score
function updateHealthScore() {
    const healthScore = healthData.health_score || {};
    const overallScore = healthScore.overall_score || {};
    const score = overallScore.score || 0;
    const grade = overallScore.grade || 'F';
    
    // Update score display
    document.getElementById('health-score-value').textContent = score;
    document.getElementById('health-grade').textContent = grade;
    
    // Update score circle
    const circle = document.getElementById('health-score-circle');
    const percentage = score;
    const color = getScoreColor(score);
    
    // Get background color based on theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const bgColor = isDark ? 'var(--bg-tertiary)' : 'var(--bs-light)';
    
    circle.style.background = `conic-gradient(${color} 0deg, ${color} ${percentage * 3.6}deg, ${bgColor} ${percentage * 3.6}deg)`;
    
    // Update categories
    updateHealthCategories(healthScore.category_scores || {});
}

// Get score color
function getScoreColor(score) {
    if (score >= 90) return 'var(--bs-success)';
    if (score >= 80) return 'var(--bs-info)';
    if (score >= 70) return 'var(--bs-warning)';
    if (score >= 60) return 'var(--bs-orange)';
    return 'var(--bs-danger)';
}

// Update health categories
function updateHealthCategories(categories) {
    const container = document.getElementById('health-categories');
    container.innerHTML = '';
    
    const categoryNames = {
        'iam_security': 'IAM Security',
        'network_security': 'Network Security',
        'data_security': 'Data Security',
        'monitoring_security': 'Monitoring Security',
        'compliance_security': 'Compliance Security',
        'access_security': 'Access Security'
    };
    
    for (const [key, data] of Object.entries(categories)) {
        const name = categoryNames[key] || key.replace('_', ' ').toUpperCase();
        const score = data.score || 0;
        const color = getScoreColor(score);
        
        const item = document.createElement('div');
        item.className = 'category-item';
        item.innerHTML = `
            <span>${name}</span>
            <span class="category-score" style="color: ${color}">${score}/100</span>
        `;
        container.appendChild(item);
    }
}

// Update metrics
function updateMetrics() {
    const summary = healthData.summary || {};
    
    document.getElementById('critical-issues').textContent = summary.critical_issues || 0;
    document.getElementById('high-issues').textContent = summary.high_issues || 0;
    document.getElementById('medium-issues').textContent = summary.medium_issues || 0;
    document.getElementById('low-issues').textContent = summary.low_issues || 0;
    
    // Update data source counts
    document.getElementById('events-count').textContent = healthData.events_count || 0;
    document.getElementById('alerts-count').textContent = healthData.alerts_count || 0;
    document.getElementById('rules-count').textContent = healthData.rules_count || 0;
}

// Update activity
function updateActivity() {
    const activity = healthData.recent_activity || [];
    const container = document.getElementById('health-activity');
    container.innerHTML = '';
    
    if (activity.length === 0) {
        container.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent activity</td></tr>';
        return;
    }
    
    activity.forEach(item => {
        const row = document.createElement('tr');
        const timestamp = new Date(item.timestamp).toLocaleString();
        const statusClass = item.status === 'success' ? 'text-success' : 
                           item.status === 'warning' ? 'text-warning' : 'text-danger';
        
        row.innerHTML = `
            <td>${timestamp}</td>
            <td>${item.component}</td>
            <td><i class="fas fa-circle ${statusClass}"></i> ${item.status}</td>
            <td>${item.message}</td>
        `;
        container.appendChild(row);
    });
}

// Refresh health data
function refreshHealth() {
    loadHealthData();
}

// Start automatic health updates
function startHealthUpdates() {
    healthUpdateInterval = setInterval(loadHealthData, 30000); // Update every 30 seconds
}

// Stop health updates when page is unloaded
window.addEventListener('beforeunload', function() {
    if (healthUpdateInterval) {
        clearInterval(healthUpdateInterval);
    }
});

// Listen for theme changes and update health score circle
document.addEventListener('themeChanged', function() {
    if (healthData && healthData.health_score) {
        updateHealthScore();
    }
});
</script>
{% endblock %}
