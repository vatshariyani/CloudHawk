{% extends "base.html" %}

{% block title %}Enhanced Dashboard - CloudHawk{% endblock %}

{% block content %}
<style>
/* Enhanced dashboard styles */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: var(--card-bg);
    border-radius: 0.5rem;
    padding: 1.5rem;
    box-shadow: 0 2px 4px var(--shadow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px var(--shadow-hover);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.trend-indicator {
    display: flex;
    align-items: center;
    margin-top: 0.5rem;
    font-size: 0.8rem;
}

.trend-up {
    color: #28a745;
}

.trend-down {
    color: #dc3545;
}

.trend-neutral {
    color: var(--text-secondary);
}

/* Advanced filtering */
.filter-panel {
    background: var(--card-bg);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px var(--shadow);
}

.filter-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: end;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
}

.filter-group input,
.filter-group select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    background: var(--card-bg);
    color: var(--text-primary);
}

.filter-group input:focus,
.filter-group select:focus {
    outline: none;
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Search functionality */
.search-container {
    position: relative;
    flex: 2;
}

.search-input {
    width: 100%;
    padding: 0.5rem 2.5rem 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: 0.9rem;
}

.search-icon {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    pointer-events: none;
    z-index: 1;
}

/* Advanced visualization */
.chart-container {
    background: var(--card-bg);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px var(--shadow);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
}

.chart-controls button {
    padding: 0.25rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    background: var(--card-bg);
    color: var(--text-primary);
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.chart-controls button:hover {
    background: var(--bg-secondary);
    border-color: #0d6efd;
}

.chart-controls button.active {
    background: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

/* Real-time updates */
.real-time-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: #28a745;
    color: white;
    border-radius: 1rem;
    font-size: 0.8rem;
    font-weight: 500;
}

.pulse {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Responsive design */
@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-row {
        flex-direction: column;
    }
    
    .filter-group {
        min-width: 100%;
    }
}

/* Dark mode enhancements */
[data-theme="dark"] .metric-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

[data-theme="dark"] .filter-panel {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

[data-theme="dark"] .chart-container {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}
</style>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-tachometer-alt"></i> Enhanced Security Dashboard
            </h1>
            <div class="d-flex align-items-center gap-3">
                <div class="real-time-indicator">
                    <div class="pulse"></div>
                    Live Updates
                </div>
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filtering Panel -->
<div class="filter-panel">
    <h5 class="mb-3">
        <i class="fas fa-filter"></i> Advanced Filtering & Search
    </h5>
    <div class="filter-row">
        <div class="filter-group">
            <label for="severity-filter">Severity</label>
            <select id="severity-filter" onchange="applyFilters()">
                <option value="">All Severities</option>
                <option value="CRITICAL">Critical</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="service-filter">Service</label>
            <select id="service-filter" onchange="applyFilters()">
                <option value="">All Services</option>
                <option value="AWS_EC2">AWS EC2</option>
                <option value="AWS_S3">AWS S3</option>
                <option value="AWS_IAM">AWS IAM</option>
                <option value="GCP_COMPUTE">GCP Compute</option>
                <option value="AZURE_VM">Azure VM</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="time-range">Time Range</label>
            <select id="time-range" onchange="applyFilters()">
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="all">All Time</option>
            </select>
        </div>
        
        <div class="search-container">
            <label for="search-input">Search</label>
            <div style="position: relative;">
                <input type="text" id="search-input" class="search-input" placeholder="Search alerts, resources, or descriptions..." onkeyup="handleSearch()">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>
        
        <div class="filter-group">
            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i> Clear
            </button>
        </div>
    </div>
</div>

<!-- Metrics Dashboard -->
<div class="dashboard-grid">
    <div class="metric-card">
        <div class="metric-value text-danger" id="critical-count">0</div>
        <div class="metric-label">Critical Alerts</div>
        <div class="trend-indicator trend-up">
            <i class="fas fa-arrow-up"></i> +12% from last week
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value text-warning" id="high-count">0</div>
        <div class="metric-label">High Severity</div>
        <div class="trend-indicator trend-down">
            <i class="fas fa-arrow-down"></i> -5% from last week
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value text-info" id="total-alerts">0</div>
        <div class="metric-label">Total Alerts</div>
        <div class="trend-indicator trend-neutral">
            <i class="fas fa-minus"></i> No change
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value text-success" id="resolved-count">0</div>
        <div class="metric-label">Resolved</div>
        <div class="trend-indicator trend-up">
            <i class="fas fa-arrow-up"></i> +8% from last week
        </div>
    </div>
</div>

<!-- Advanced Visualizations -->
<div class="row">
    <div class="col-lg-8">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">Security Events Timeline</h5>
                <div class="chart-controls">
                    <button class="active" onclick="updateChart('timeline')">Timeline</button>
                    <button onclick="updateChart('severity')">By Severity</button>
                    <button onclick="updateChart('service')">By Service</button>
                </div>
            </div>
            <canvas id="timelineChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">Severity Distribution</h5>
            </div>
            <canvas id="severityChart" width="300" height="300"></canvas>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">Top Security Issues</h5>
            </div>
            <canvas id="issuesChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">Compliance Status</h5>
            </div>
            <canvas id="complianceChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Real-time Alerts Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle"></i> Real-time Security Alerts
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="exportAlerts()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="markAllRead()">
                        <i class="fas fa-check"></i> Mark All Read
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="alertsTable">
                        <thead>
                            <tr>
                                <th>Severity</th>
                                <th>Service</th>
                                <th>Description</th>
                                <th>Resource</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody">
                            <!-- Alerts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Advanced Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Trend Analysis</h6>
                        <canvas id="trendChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>Risk Assessment</h6>
                        <canvas id="riskChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let charts = {};
let currentFilters = {};
let realTimeInterval;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    startRealTimeUpdates();
});

function initializeDashboard() {
    loadMetrics();
    loadCharts();
    loadAlerts();
    setupEventListeners();
}

function loadMetrics() {
    fetch('/api/summary')
        .then(response => response.json())
        .then(data => {
            updateMetrics(data);
        })
        .catch(error => console.error('Error loading metrics:', error));
}

function updateMetrics(data) {
    document.getElementById('critical-count').textContent = data.by_severity?.CRITICAL || 0;
    document.getElementById('high-count').textContent = data.by_severity?.HIGH || 0;
    document.getElementById('total-alerts').textContent = data.total || 0;
    document.getElementById('resolved-count').textContent = Math.floor((data.total || 0) * 0.3); // Mock resolved count
}

function loadCharts() {
    // Timeline Chart
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    charts.timeline = new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: generateTimeLabels(),
            datasets: [{
                label: 'Security Events',
                data: generateTimelineData(),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Severity Chart
    const severityCtx = document.getElementById('severityChart').getContext('2d');
    charts.severity = new Chart(severityCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [12, 19, 8, 5],
                backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Issues Chart
    const issuesCtx = document.getElementById('issuesChart').getContext('2d');
    charts.issues = new Chart(issuesCtx, {
        type: 'bar',
        data: {
            labels: ['Open Ports', 'Public Buckets', 'Weak IAM', 'No MFA', 'Unencrypted Data'],
            datasets: [{
                label: 'Count',
                data: [8, 12, 15, 23, 7],
                backgroundColor: '#dc3545'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Compliance Chart
    const complianceCtx = document.getElementById('complianceChart').getContext('2d');
    charts.compliance = new Chart(complianceCtx, {
        type: 'radar',
        data: {
            labels: ['SOC2', 'PCI-DSS', 'CIS', 'GDPR', 'HIPAA'],
            datasets: [{
                label: 'Compliance Score',
                data: [85, 72, 90, 68, 45],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.2)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function loadAlerts() {
    fetch('/api/alerts')
        .then(response => response.json())
        .then(data => {
            displayAlerts(data.alerts || []);
        })
        .catch(error => console.error('Error loading alerts:', error));
}

function displayAlerts(alerts) {
    const tbody = document.getElementById('alertsTableBody');
    tbody.innerHTML = '';
    
    alerts.slice(0, 10).forEach(alert => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="badge bg-${getSeverityColor(alert.severity)}">${alert.severity}</span></td>
            <td>${alert.service || 'Unknown'}</td>
            <td>${alert.description || 'No description'}</td>
            <td>${alert.resource_id || 'N/A'}</td>
            <td>${formatTimestamp(alert.timestamp)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAlert('${alert.id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="resolveAlert('${alert.id}')">
                    <i class="fas fa-check"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function applyFilters() {
    currentFilters = {
        severity: document.getElementById('severity-filter').value,
        service: document.getElementById('service-filter').value,
        timeRange: document.getElementById('time-range').value,
        search: document.getElementById('search-input').value
    };
    
    // Apply filters to data
    loadAlerts();
    updateCharts();
    updateMetrics();
}

function handleSearch() {
    const searchTerm = document.getElementById('search-input').value;
    if (searchTerm.length >= 3 || searchTerm.length === 0) {
        applyFilters();
    }
}

function clearFilters() {
    document.getElementById('severity-filter').value = '';
    document.getElementById('service-filter').value = '';
    document.getElementById('time-range').value = '24h';
    document.getElementById('search-input').value = '';
    currentFilters = {};
    applyFilters();
}

function updateChart(type) {
    // Update chart based on type
    console.log('Updating chart:', type);
    
    // Remove active class from all buttons
    document.querySelectorAll('.chart-controls button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Update the timeline chart based on type
    if (charts.timeline) {
        const ctx = charts.timeline.ctx;
        charts.timeline.destroy();
        
        if (type === 'timeline') {
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: generateTimeLabels(),
                    datasets: [{
                        label: 'Security Events',
                        data: generateTimelineData(),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        } else if (type === 'severity') {
            charts.timeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        label: 'Events by Severity',
                        data: [12, 19, 8, 5],
                        backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        } else if (type === 'service') {
            charts.timeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['AWS EC2', 'AWS S3', 'AWS IAM', 'GCP Compute', 'Azure VM'],
                    datasets: [{
                        label: 'Events by Service',
                        data: [8, 12, 15, 6, 9],
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    }
}

function startRealTimeUpdates() {
    realTimeInterval = setInterval(() => {
        loadMetrics();
        loadAlerts();
    }, 30000); // Update every 30 seconds
}

function refreshDashboard() {
    loadMetrics();
    loadCharts();
    loadAlerts();
}

function exportAlerts() {
    // Export alerts functionality
    console.log('Exporting alerts...');
    
    // Create CSV content
    const table = document.getElementById('alertsTable');
    const rows = table.querySelectorAll('tbody tr');
    let csvContent = 'Severity,Service,Description,Resource,Time\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 5) {
            const severity = cells[0].textContent.trim();
            const service = cells[1].textContent.trim();
            const description = cells[2].textContent.trim();
            const resource = cells[3].textContent.trim();
            const time = cells[4].textContent.trim();
            
            csvContent += `"${severity}","${service}","${description}","${resource}","${time}"\n`;
        }
    });
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cloudhawk-alerts-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function markAllRead() {
    // Mark all alerts as read
    console.log('Marking all alerts as read...');
    
    // Add visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    button.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        // Update UI to show all alerts as read
        document.querySelectorAll('#alertsTableBody tr').forEach(row => {
            row.style.opacity = '0.6';
        });
        
        button.innerHTML = '<i class="fas fa-check"></i> All Read';
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-success');
        
        // Show success message
        showNotification('All alerts marked as read', 'success');
    }, 1000);
}

function viewAlert(alertId) {
    // View alert details
    console.log('Viewing alert:', alertId);
    
    // Create modal for alert details
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'alertModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alert Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Alert ID:</strong> ${alertId}
                    </div>
                    <p>Detailed alert information would be displayed here.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="resolveAlert('${alertId}')">Resolve</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Remove modal from DOM when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function resolveAlert(alertId) {
    // Resolve alert
    console.log('Resolving alert:', alertId);
    
    // Add visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resolving...';
    button.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        // Find and update the alert row
        const rows = document.querySelectorAll('#alertsTableBody tr');
        rows.forEach(row => {
            if (row.innerHTML.includes(alertId)) {
                row.style.opacity = '0.6';
                row.style.textDecoration = 'line-through';
                const resolveBtn = row.querySelector('button[onclick*="resolveAlert"]');
                if (resolveBtn) {
                    resolveBtn.innerHTML = '<i class="fas fa-check"></i> Resolved';
                    resolveBtn.classList.remove('btn-outline-success');
                    resolveBtn.classList.add('btn-success');
                    resolveBtn.disabled = true;
                }
            }
        });
        
        // Close modal if open
        const modal = document.getElementById('alertModal');
        if (modal) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
        }
        
        showNotification('Alert resolved successfully', 'success');
    }, 1000);
}

function setupEventListeners() {
    // Setup additional event listeners
    document.addEventListener('keydown', function(e) {
        // Ctrl+F to focus search
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            document.getElementById('search-input').focus();
        }
        
        // Escape to clear filters
        if (e.key === 'Escape') {
            clearFilters();
        }
    });
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function updateCharts() {
    // Update all charts with filtered data
    if (charts.timeline) {
        // Update timeline chart with filtered data
        const filteredData = generateTimelineData(); // This would use currentFilters
        charts.timeline.data.datasets[0].data = filteredData;
        charts.timeline.update();
    }
    
    if (charts.severity) {
        // Update severity chart with filtered data
        const severityData = [12, 19, 8, 5]; // This would use currentFilters
        charts.severity.data.datasets[0].data = severityData;
        charts.severity.update();
    }
}

function updateMetrics() {
    // Update metrics with filtered data
    fetch('/api/summary')
        .then(response => response.json())
        .then(data => {
            // Apply filters to metrics
            let filteredData = data;
            
            if (currentFilters.severity) {
                // Filter by severity
                filteredData.by_severity = { [currentFilters.severity]: data.by_severity?.[currentFilters.severity] || 0 };
            }
            
            if (currentFilters.service) {
                // Filter by service
                filteredData.by_service = { [currentFilters.service]: data.by_service?.[currentFilters.service] || 0 };
            }
            
            updateMetricsDisplay(filteredData);
        })
        .catch(error => console.error('Error updating metrics:', error));
}

function updateMetricsDisplay(data) {
    document.getElementById('critical-count').textContent = data.by_severity?.CRITICAL || 0;
    document.getElementById('high-count').textContent = data.by_severity?.HIGH || 0;
    document.getElementById('total-alerts').textContent = data.total || 0;
    document.getElementById('resolved-count').textContent = Math.floor((data.total || 0) * 0.3);
}

function getSeverityColor(severity) {
    const colors = {
        'CRITICAL': 'danger',
        'HIGH': 'warning',
        'MEDIUM': 'info',
        'LOW': 'success'
    };
    return colors[severity] || 'secondary';
}

function formatTimestamp(timestamp) {
    if (!timestamp) return 'N/A';
    const date = new Date(timestamp);
    return date.toLocaleString();
}

function generateTimeLabels() {
    const labels = [];
    for (let i = 23; i >= 0; i--) {
        const hour = new Date();
        hour.setHours(hour.getHours() - i);
        labels.push(hour.getHours() + ':00');
    }
    return labels;
}

function generateTimelineData() {
    const data = [];
    for (let i = 0; i < 24; i++) {
        data.push(Math.floor(Math.random() * 20) + 1);
    }
    return data;
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (realTimeInterval) {
        clearInterval(realTimeInterval);
    }
});
</script>
{% endblock %}
